From 0cacf1ec6f9fb8784ade25dff6a3f2d8d493e122 Mon Sep 17 00:00:00 2001
From: Madelen Andersson <madelan@axis.com>
Date: Tue, 4 Jul 2023 09:18:00 +0200
Subject: [PATCH] Changed cgroup name for rootless

Change-Id: Ic59a75acae25241fbb71690ee6858cf471ea9fa4
---
 daemon/daemon_unix.go | 3 ++-
 daemon/oci_linux.go   | 7 ++++---
 2 files changed, 6 insertions(+), 4 deletions(-)

diff --git a/daemon/daemon_unix.go b/daemon/daemon_unix.go
index 4b504c871e..6563fa985c 100644
--- a/daemon/daemon_unix.go
+++ b/daemon/daemon_unix.go
@@ -1529,7 +1529,8 @@ func getSysInfo(daemon *Daemon) *sysinfo.SysInfo {
 	var siOpts []sysinfo.Opt
 	if daemon.getCgroupDriver() == cgroupSystemdDriver {
 		if euid := os.Getenv("ROOTLESSKIT_PARENT_EUID"); euid != "" {
-			siOpts = append(siOpts, sysinfo.WithCgroup2GroupPath("/user.slice/user-"+euid+".slice"))
+			//siOpts = append(siOpts, sysinfo.WithCgroup2GroupPath("/user.slice/user-"+euid+".slice"))
+			siOpts = append(siOpts, sysinfo.WithCgroup2GroupPath("/extension.slice/extension-acap.slice"))
 		}
 	}
 	return sysinfo.New(siOpts...)
diff --git a/daemon/oci_linux.go b/daemon/oci_linux.go
index 015a429944..426f1e609b 100644
--- a/daemon/oci_linux.go
+++ b/daemon/oci_linux.go
@@ -95,11 +95,12 @@ func WithRootless(daemon *Daemon) coci.SpecOpts {
 			if rootlesskitParentEUID == "" {
 				return errors.New("$ROOTLESSKIT_PARENT_EUID is not set (requires RootlessKit v0.8.0)")
 			}
-			euid, err := strconv.Atoi(rootlesskitParentEUID)
+			_, err := strconv.Atoi(rootlesskitParentEUID)
 			if err != nil {
 				return errors.Wrap(err, "invalid $ROOTLESSKIT_PARENT_EUID: must be a numeric value")
 			}
-			controllersPath := fmt.Sprintf("/sys/fs/cgroup/user.slice/user-%d.slice/cgroup.controllers", euid)
+			//controllersPath := fmt.Sprintf("/sys/fs/cgroup/user.slice/user-%d.slice/cgroup.controllers", euid)
+			controllersPath := fmt.Sprintf("/sys/fs/cgroup/extension.slice/extension-acap.slice/cgroup.controllers")
 			controllersFile, err := os.ReadFile(controllersPath)
 			if err != nil {
 				return err
@@ -798,7 +799,7 @@ func WithCgroups(daemon *Daemon, c *container.Container) coci.SpecOpts {
 		if useSystemd {
 			parent = "system.slice"
 			if daemon.configStore.Rootless {
-				parent = "user.slice"
+				parent = "extension-acap.slice"
 			}
 		}
 
-- 
2.25.1

